<!-- registro-contabil.component.html -->
<div class="pagina">
  <aside class="sidebar" [ngClass]="{ 'retraida': sidebarRetraida }">
    <div class="sidebar-header">
      <button class="hamburger-btn" (click)="toggleSidebar()">
        <i class="bx bx-menu"></i>
      </button>
      <div class="logo" *ngIf="!sidebarRetraida">mister <strong>contador</strong></div>
    </div>
    <nav>
      <ul>
        <li class="">
          <i class="bx bx-home"></i>
          <span *ngIf="!sidebarRetraida">Início</span>
        </li>
        <li>
          <i class="bx bx-bar-chart-alt"></i>
          <span *ngIf="!sidebarRetraida">Estatísticas</span>
        </li>
        <li class="active">
          <i class="bx bx-book"></i>
          <span *ngIf="!sidebarRetraida">Registro Contábil</span>
        </li>
        <li>
          <i class="bx bx-file"></i>
          <span *ngIf="!sidebarRetraida">Nf-e</span>
        </li>
        <li>
          <i class="bx bx-file"></i>
          <span *ngIf="!sidebarRetraida">NFS-e</span>
        </li>
        <li>
          <i class="bx bx-receipt"></i>
          <span *ngIf="!sidebarRetraida">Comprovantes</span>
        </li>
        <li>
          <i class="bx bx-credit-card"></i>
          <span *ngIf="!sidebarRetraida">Cartão de Crédito</span>
        </li>
        <li>
          <i class="bx bx-file-blank"></i>
          <span *ngIf="!sidebarRetraida">Extrato bancário</span>
        </li>
        <li>
          <i class="bx bx-list-ul"></i>
          <span *ngIf="!sidebarRetraida">Plano de Contas</span>
        </li>
        <li>
          <i class="bx bx-cog"></i>
          <span *ngIf="!sidebarRetraida">Regras</span>
        </li>
        <li>
          <i class="bx bx-buildings"></i>
          <span *ngIf="!sidebarRetraida">Agência bancária</span>
        </li>
        <li>
          <i class="bx bx-building"></i>
          <span *ngIf="!sidebarRetraida">Empresa</span>
        </li>
        <li>
          <i class="bx bx-user-check"></i>
          <span *ngIf="!sidebarRetraida">Permissões</span>
        </li>
        <li>
          <i class="bx bx-log-out"></i>
          <span *ngIf="!sidebarRetraida">Sair</span>
        </li>
      </ul>
    </nav>
  </aside>

  <main class="conteudo">
    <header class="topo">
      <div class="header-linha">
        <h1>Registro Contábil</h1>

        <!-- Informações da Empresa -->
        <div class="empresa-info-navbar">
          <div class="campo-empresa">
            <label>Empresa:</label>
            <input type="text" value="Empresa Exemplo Ltda" readonly>
          </div>
          <div class="campo-cnpj">
            <label>CNPJ:</label>
            <input type="text" value="12.345.678/0001-90" readonly>
          </div>
        </div>
      </div>

      <div class="filtros">

        <div class="dropdown">
          <button class="btn btn-outline-seundary dropdown-toggle" data-bs-toggle="dropdown">
            <img class="bank-img"
              src="https://yt3.googleusercontent.com/YoY6PQUzk6UXJEW8sTYs8zf_TfPLHNLSim65mswp_w5CX0jYgtl_le41QPRwoI1Hyj4OM2q_=s900-c-k-c0x00ffffff-no-rj">
            3174 / 40106
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">
                <img class="bank-img"
                  src="https://play-lh.googleusercontent.com/dLVmnD6SlKMWO8_iiw5Cepca0zqmJq3zMaAfXXp6kJfrVBgctX2qTClAOCuaCLn-XmQ">
                0001 / 545498</a></li>
          </ul>
        </div>
        <button type="button" class="btn btn-outline-primary">7-111.02.0001</button>
        <div class="calendario-principal-container">
          <div class="calendario-principal-input" (click)="abrirCalendarioPrincipal()">
            <span>{{ formatarDataExibicaoPrincipal() }}</span>
            <i class="bx bx-calendar"></i>
          </div>

          <!-- Calendário Principal Completo -->
          <div class="calendario-principal" *ngIf="mostrarCalendarioPrincipal" (click)="$event.stopPropagation()">
            <div class="calendario-header">
              <button type="button" (click)="alterarAnoPrincipal(-1)" class="nav-btn">
                <i class="bx bx-chevrons-left"></i>
              </button>

              <span class="calendario-title">{{ anoCalendarioPrincipal }}</span>

              <button type="button" (click)="alterarAnoPrincipal(1)" class="nav-btn">
                <i class="bx bx-chevrons-right"></i>
              </button>
            </div>

            <div class="calendario-grid-meses">
              <div *ngFor="let mes of getMesesDoAno(); let i = index"
                   class="calendario-mes-cell"
                   [class.mes-atual]="isMesAtualPrincipal(i)"
                   [class.mes-selecionado]="isMesSelecionadoPrincipal(i)"
                   (click)="selecionarMesPrincipal(i)">
                {{ mes }}
              </div>
            </div>

            <div class="calendario-footer">
              <button type="button" (click)="fecharCalendarioPrincipal()" class="btn-fechar">Fechar</button>
            </div>
          </div>
        </div>
        <input type="text" placeholder="Pesquisar..." class="pesquisa" />
        <!-- Botões à direita dos filtros -->
        <div class="acoes-botoes d-flex align-items-center gap-2 ms-auto">
          <button class="btn btn-primary">
            <i class="bx bx-list-ul"></i>
          </button>

          <!-- Dropdown "Ações" -->
          <div class="dropdown">
            <button class="btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Ações
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item disabled" href="#">Exportar Lançamentos Contábeis</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Entrada</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Saída</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Tomado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Prestado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Simples Conferência</a></li>
              <li><a class="dropdown-item disabled" href="#">Associação Múltipla</a></li>
              <li><a class="dropdown-item disabled" href="#">Gerar Ticket</a></li>
            </ul>
          </div>

          <!-- Botão Excluir -->
          <button class="btn btn-primary">Excluir</button>
        </div>

      </div>

    </header>
    <hr />
    <section class="abas">
      <button [ngClass]="{ 'ativa': abaSelecionada === 'lancamentos' }" (click)="selecionarAba('lancamentos')">
        Lançamentos <span class="badge azul">{{ getContadorLancamentos() }}</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'conciliados' }" (click)="selecionarAba('conciliados')">
        Conciliados <span class="badge verde">{{ getContadorConciliados() }}</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'naoConciliados' }" (click)="selecionarAba('naoConciliados')">
        Não-Conciliados <span class="badge vermelho">{{ getContadorNaoConciliados() }}</span>
      </button>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button class="btn btn-outline-primary" (click)="editarSaldoInicial()">
          Saldo Inicial: {{ formatarMoeda(saldoInicial) }}
        </button>
        <button class="btn btn-outline-primary">
          Saldo Final: {{ formatarMoeda(saldoFinal) }}
        </button>
      </div>
    </section>

    <section class="tabela"
             [ngClass]="{
               'tabela-lancamentos': abaSelecionada === 'lancamentos',
               'tabela-conciliados': abaSelecionada === 'conciliados',
               'tabela-nao-conciliados': abaSelecionada === 'naoConciliados'
             }">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Classificação</th>
            <th>Conta<br>Débito</th>
            <th>Conta<br>Crédito</th>
            <th>Valor</th>
            <th>Histórico</th>
            <th>Comprovante </th>
            <th>Nota</th>
            <th>Cliente</th>
            <th>Anexos</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let linha of dadosLancamentosFiltrados; let i = index"
              [class.linha-nao-conciliada]="!isConciliado(linha)">
            <td>{{ linha.data }}</td>
            <td>{{ linha.classificacao }}</td>

            <!-- Conta Débito -->
            <td>
              <i class="bx bx-book icone-clicavel"
                 *ngIf="getIndiceReal(i) === 0"
                 (click)="abrirModalAssociacaoConta(getIndiceReal(i)); $event.stopPropagation()"
                 title="Associar conta de débito"></i>
              {{ linha.debito }}
            </td>

            <!-- Conta Crédito -->
            <td>
              <i class="bx bx-book icone-clicavel"
                 *ngIf="getIndiceReal(i) === 1"
                 (click)="abrirModalAssociacaoConta(getIndiceReal(i)); $event.stopPropagation()"
                 title="Associar conta de crédito"></i>
              <span *ngIf="getIndiceReal(i) !== 2" class="numero-conta">{{ linha.credito }}</span>
              <span *ngIf="getIndiceReal(i) === 2"
                    class="numero-conta-link numero-conta-hover"
                    (click)="abrirModalAssociacaoConta(getIndiceReal(i)); $event.stopPropagation()"
                    title="Clique para editar associação da conta">{{ linha.credito }}
                <i class="bx bx-minus icone-desassociar"
                   (click)="desassociarConta(getIndiceReal(i)); $event.stopPropagation()"
                   title="Desassociar conta"></i>
              </span>
            </td>

            <td>{{ linha.valor }}</td>

            <td class="historico-editavel">
              <span *ngIf="!linha.editandoHistorico" class="texto-historico" (click)="abrirModalRegra(getIndiceReal(i)); $event.stopPropagation()">{{ linha.historico }}</span>
              <input *ngIf="linha.editandoHistorico"
                     type="text"
                     [(ngModel)]="linha.historico"
                     class="input-edicao-historico"
                     (blur)="finalizarEdicaoHistorico(getIndiceReal(i))"
                     (keydown.enter)="finalizarEdicaoHistorico(getIndiceReal(i))"
                     (keydown.escape)="cancelarEdicaoHistorico(getIndiceReal(i))"
                     #inputHistorico />
              <i *ngIf="!linha.editandoHistorico" class="bx bx-pencil icone-edicao"
                 (click)="iniciarEdicaoHistorico(getIndiceReal(i)); $event.stopPropagation()"></i>
            </td>

            <td><i class="bx bx-file"></i></td>
            <td>
              <span *ngIf="linha.temContaAutomatica">{{ linha.nota }}</span>
              <i *ngIf="!linha.temContaAutomatica" class="bx bx-pencil"
                 style="cursor: pointer; color: #007bff;"
                 (click)="abrirModal(getIndiceReal(i)); $event.stopPropagation()"
                 title="Clique para abrir o modal de lançamento contábil"></i>
            </td>
            <td>{{ linha.cliente }}</td>
            <td><i class="bx bx-paperclip"></i></td>
            <td>{{ linha.saldo }}</td>
          </tr>
        </tbody>

      </table>
    </section>


    <!-- Modal Lançamento usando o novo componente -->
    <app-modal-lancamento
      [isVisible]="!!lancamentoSelecionado"
      [lancamento]="lancamentoSelecionado"
      (fechado)="lancamentoSelecionado = null"
      (regrapressed)="abrirModalRegra()"
      (gravado)="onLancamentoGravado($event)">
    </app-modal-lancamento>





    <!-- Modal regra -->
    <app-modal-regra
      [modalAberto]="modalAberto && !modoAssociacaoConta"
      [lancamentoSelecionadoIndex]="lancamentoSelecionadoIndex"
      [dadosLancamentos]="dadosLancamentos"
      (fecharModal)="fecharModalRegra()">
    </app-modal-regra>

    <!-- Modal associação de conta -->
    <app-modal-associacao-conta
      [modalAberto]="modalAberto && modoAssociacaoConta"
      [lancamentoSelecionadoIndex]="lancamentoSelecionadoIndex"
      [dadosLancamentos]="dadosLancamentos"
      [contaContabilInput]="contaContabilInput"
      [historicoInput]="historicoInput"
      (fecharModalEvento)="fecharModalRegra()">
    </app-modal-associacao-conta>


  </main>
</div>
