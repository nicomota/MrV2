<!-- registro-contabil.component.html -->
<div class="pagina">
  <aside class="sidebar">
    <div class="logo">mister <strong>contador</strong></div>
    <nav>
      <ul>
        <li class="active"><i class="bx bx-user"></i> Clientes</li>
        <li><i class="bx bx-bar-chart-alt"></i> Estatísticas</li>
        <li><i class="bx bx-book"></i> Registro Contábil</li>
        <li><i class="bx bx-bank"></i> Extrato Bancário</li>
        <li><i class="bx bx-receipt"></i> Comprovante de Pagto</li>
        <li><i class="bx bx-file"></i> NF-E</li>
        <li><i class="bx bx-cog"></i> Parâmetros - Regras</li>
        <li><i class="bx bx-credit-card"></i> Cartões - Débito/Crédito</li>
        <li><i class="bx bx-transfer"></i> Integrações Realizadas</li>
        <li><i class="bx bx-log-out"></i> Sair</li>
      </ul>
    </nav>
  </aside>

  <main class="conteudo">
    <header class="topo">
      <h1>Registro Contábil</h1>
      <div class="filtros">

        <div class="dropdown">
          <button class="btn btn-outline-seundary dropdown-toggle" data-bs-toggle="dropdown">
            <img class="bank-img"
              src="https://yt3.googleusercontent.com/YoY6PQUzk6UXJEW8sTYs8zf_TfPLHNLSim65mswp_w5CX0jYgtl_le41QPRwoI1Hyj4OM2q_=s900-c-k-c0x00ffffff-no-rj">
            3174 / 40106
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">
                <img class="bank-img"
                  src="https://play-lh.googleusercontent.com/dLVmnD6SlKMWO8_iiw5Cepca0zqmJq3zMaAfXXp6kJfrVBgctX2qTClAOCuaCLn-XmQ">
                0001 / 545498</a></li>
          </ul>
        </div>
        <button type="button" class="btn btn-outline-primary">7-111.02.0001</button>
        <div class="mes-selector">
          <button (click)="anteriorMes()" class="btn-seta">
            <i class="bx bx-chevron-left"></i>
          </button>

          <button class="btn-mes" (click)="toggleDropdown()">
            {{ mesSelecionado }}
          </button>

          <button (click)="proximoMes()" class="btn-seta">
            <i class="bx bx-chevron-right"></i>
          </button>

          <div class="dropdown-meses" *ngIf="dropdownAberto">
            <div *ngFor="let mes of mesesAno" (click)="selecionarMes(mes)">
              {{ mes }}
            </div>
          </div>
        </div>
        <input type="text" placeholder="Pesquisar..." class="pesquisa" />
        <!-- Botões à direita dos filtros -->
        <div class="acoes-botoes d-flex align-items-center gap-2 ms-auto">
          <button class="btn btn-primary">
            <i class="bx bx-list-ul"></i>
          </button>

          <!-- Dropdown "Ações" -->
          <div class="dropdown">
            <button class="btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Ações
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item disabled" href="#">Exportar Lançamentos Contábeis</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Entrada</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Saída</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Tomado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Prestado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Simples Conferência</a></li>
              <li><a class="dropdown-item disabled" href="#">Gerar Ticket</a></li>
            </ul>
          </div>

          <!-- Botão Excluir -->
          <button class="btn btn-primary">Excluir</button>
        </div>

      </div>

    </header>
    <hr />
    <section class="abas">
      <button [ngClass]="{ 'ativa': abaSelecionada === 'lancamentos' }" (click)="selecionarAba('lancamentos')">
        Lançamentos <span class="badge azul">0002</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'conciliados' }" (click)="selecionarAba('conciliados')">
        Conciliados <span class="badge verde">0003</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'naoConciliados' }" (click)="selecionarAba('naoConciliados')">
        Não-Conciliados <span class="badge vermelho">0002</span>
      </button>
    </section>

    <section class="tabela">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Classificação</th>
            <th>Conta<br>Débito</th>
            <th>Conta<br>Crédito</th>
            <th>Valor</th>
            <th>Histórico</th>
            <th>Comprovante </th>
            <th>Nota</th>
            <th>Cliente</th>
            <th>Anexos</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let linha of dadosLancamentos; let i = index" (click)="abrirModal(i)">
            <td>{{ linha.data }}</td>
            <td>{{ linha.classificacao }}</td>

            <!-- Conta Débito (ícone só se houver crédito) -->
            <td>
              <i class="bx bx-book icone-clicavel" *ngIf="linha.credito"
                (click)="abrirModalConta(linha.historico); $event.stopPropagation()"></i>
              {{ linha.debito }}
            </td>

            <!-- Conta Crédito (ícone só se crédito estiver vazio, e houver débito) -->
            <td>
              <i class="bx bx-book icone-clicavel" *ngIf="!linha.credito && linha.debito"
                (click)="abrirModalConta(linha.historico); $event.stopPropagation()"></i>
              {{ linha.credito }}
            </td>

            <td>{{ linha.valor }}</td>

            <td class="conta-clicavel" (click)="abrirModalRegra(); $event.stopPropagation()">
              {{ linha.historico }}
            </td>

            <td class="text-center"><i class="bx bx-file"></i></td>
            <td>{{ linha.nota }}</td>
            <td>{{ linha.cliente }}</td>
            <td><i class="bx bx-paperclip"></i></td>
            <td>
              <span class="status" [ngClass]="linha.status"></span>
            </td>
          </tr>
        </tbody>

      </table>
    </section>


    <!-- Modal Lançamento -->
    <!-- Modal Lançamento atualizado -->
    <div class="modal-lancamento" *ngIf="lancamentoSelecionado">
      <div class="modal-conteudo grande">
        <button class="fechar" (click)="lancamentoSelecionado = null">&times;</button>
        <h1 class="titulo">Lançamento Contábil</h1>
        <hr />

        <div class="linha">
          <div><label>Data:</label> <input type="text" [value]="lancamentoSelecionado.data" readonly /></div>
          <div><label>Usuário:</label> <input type="text" value="Diego" readonly /></div>
          <div><label>Empresa:</label> <input type="text" [value]="lancamentoSelecionado.cliente" readonly /></div>
          <div>
            <label>Tipo:</label>
            <select [(ngModel)]="tipoSelecionado" (change)="onTipoSelecionado()">
              <option disabled [selected]="!tipoSelecionado">Selecione um tipo</option>
              <option *ngFor="let tipo of tiposDisponiveis" [value]="tipo">{{ tipo }}</option>
            </select>
          </div>
          <div style="align-self: flex-end;">
            <label style="visibility: hidden;">Criar Regra</label>
            <button class="btn-criar-regra" (click)="abrirModalRegra()">Criar Regra</button>
          </div>
        </div>

        <hr />

        <div class="linha">
          <div><label>Conta Contábil D:</label> <input type="text" [value]="lancamentoSelecionado?.debito" readonly />
          </div>
          <div><label>Conta Contábil C:</label> <input type="text" [value]="lancamentoSelecionado?.credito" readonly />
          </div>
          <!-- <div><label>Banco:</label> <input type="text" value="7 - BANCO DO BRASIL" readonly /></div> -->
          <div><label>Valor:</label> <input type="text" [value]="lancamentoSelecionado.valor" readonly /></div>
          <div><label>Histórico Contábil:</label> <input type="text" [value]="lancamentoSelecionado.historico"
              readonly /></div>
        </div>

        <hr />

        <table class="subtabela">
          <thead>
            <tr>
              <th>Debitar</th>
              <th>Creditar</th>
              <th>Classificação</th>
              <th>Descrição</th>
              <th>Valor</th>
              <th>Histórico Contábil</th>
              <th>Excluir</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let linha of linhasSubtabela; let i = index">
              <!-- Debitar -->
              <td>
                <input *ngIf="linha.tipo === 'debito'" type="text" [(ngModel)]="linha.debitar"
                  [readonly]="!linha.editavel">
                <span *ngIf="linha.tipo === 'credito'">-</span>
              </td>

              <!-- Conta -->
              <td>
                <ng-container *ngIf="linha.tipo === 'credito'; else contaTraco">
                  <input type="text" [(ngModel)]="linha.conta" [readonly]="!linha.editavel" /> 
                </ng-container>
                <ng-template #contaTraco>-</ng-template>
              </td>

              <!-- Classificação -->
              <td>
                <input type="text" [(ngModel)]="linha.classificacao" [readonly]="!linha.editavel">
              </td>

              <!-- Descrição -->
              <td>
                <input type="text" [(ngModel)]="linha.descricao" [readonly]="!linha.editavel">
              </td>

              <!-- Valor -->
              <td>
                <input type="text" [(ngModel)]="linha.valor" (ngModelChange)="atualizarTotais()" [readonly]="!linha.editavel">
              </td>

              <!-- Histórico -->
              <td>
                <input type="text" [(ngModel)]="linha.historico" [readonly]="!linha.editavel">
              </td>

              <!-- Ações -->
              <td>
                <button *ngIf="linha.editavel" class="btn btn-outline-danger btn-sm"
                  (click)="removerLinha(i)">−</button>
              </td>
            </tr>
          </tbody>

        </table>



        <!-- Botões de adicionar linha -->
        <div class="botoes-linhas" style="margin-top: 1rem;">
          <!-- Para tipos N x N: mostra dois botões -->
          <ng-container
            *ngIf="tipoSelecionado === 'N Débito p/ N Crédito' || tipoSelecionado === 'N Crédito p/ N Débito'">
            <button (click)="adicionarLinha('debito')">+ Adicionar Débito</button>
            <button (click)="adicionarLinha('credito')">+ Adicionar Crédito</button>
          </ng-container>

          <!-- Para tipos Um x Vários: botão único -->
          <ng-container *ngIf="tipoSelecionado === 'Um Débito p/ vários Créditos'">
            <button (click)="adicionarLinha('credito')">+ Adicionar Crédito</button>
          </ng-container>

          <ng-container *ngIf="tipoSelecionado === 'Um Crédito p/ vários Débitos'">
            <button (click)="adicionarLinha('debito')">+ Adicionar Débito</button>
          </ng-container>
        </div>

        <hr />

        <div class="linha-final">
          <div><label>Débito:</label>
            <input type="text" [value]="totalDebito | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
          </div>
          <div><label>Crédito:</label>
            <input type="text" [value]="totalCredito | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
          </div>
          <div><label>Diferença:</label>
            <input type="text" [value]="diferenca | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
          </div>
          <div><label>Doc nº:</label> <input type="text" value="0199999999" readonly /></div>
          <div><button class="botao-nfe">Nf-e {{ lancamentoSelecionado.nota }}</button></div>
        </div>

        <div class="rodape-modal">
          <button class="btn-cancelar" (click)="lancamentoSelecionado = null">Cancelar</button>
          <button class="btn-gravar">Gravar</button>
        </div>
      </div>
    </div>




    <!-- Modal regra -->
    <div class="modal-regra" *ngIf="modalAberto" (click)="fecharModalRegra()">
      <div class="modal-conteudo-regra" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Associação de Regra</h2>
          <button class="fechar" (click)="fecharModalRegra()">×</button>
        </div>
        <div class="modal-body">
          <div class="linha">
            <div>
              <label>Data:</label>
              <input type="date" />
            </div>
            <div>
              <label>Agência Bancária:</label>
              <input type="text" value="4480/2861" readonly />
            </div>
          </div>
          <div class="linha">
            <div style="flex: 1; display: flex; flex-direction: column; gap: 0.75rem;">
              <div>
                <label>Débito:</label>
                <input type="text" />
              </div>
              <div>
                <label>Crédito:</label>
                <input type="text" />
              </div>
            </div>
            <div class="descricao-inline" style="flex: 1;">
              <label for="descricao">Descrição:</label>
              <select id="descricao">
                <option disabled selected>Selecione uma descrição</option>
                <option>Pagamento Fornecedor</option>
                <option>Transferência Interna</option>
              </select>
            </div>
          </div>
          <div class="linha">
            <div>
              <label>Valor:</label>
              <input type="text" />
            </div>
            <div>
              <label>Expressão:</label>
              <input type="text" />
            </div>
          </div>
          <div class="linha">
            <div style="flex: 1;">
              <label>Histórico Contábil:</label>
              <input type="text" />
            </div>
          </div>
        </div>
        <div class="rodape-modal">
          <button class="btn btn-primary" (click)="fecharModalRegra()">Cancelar</button>
          <button class="btn btn-primary">Gravar</button>
        </div>
      </div>
    </div>

    <!-- Modal Conta Contábil -->
    <div class="modal-conta" *ngIf="mostrarModalConta">
      <div class="modal-conteudo-conta">
        <div class="modal-header">
          <h2>Associar Conta Contábil</h2>
          <button class="fechar" (click)="fecharModalConta()">×</button>
        </div>

        <div class="modal-body">
          <div class="linha">
            <div style="flex: 1;">
              <label>Conta Contábil</label>
              <input type="text" placeholder="Conta Contábil" />
            </div>
          </div>

          <div class="linha">
            <div style="flex: 1;">
              <label>Histórico</label>
              <input type="text" readonly [value]="historicoSelecionado" />
            </div>
          </div>
        </div>

        <div class="rodape-modal">
          <button class="btn btn-primary" (click)="fecharModalConta()">Cancelar</button>
          <button class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>

  </main>
</div>
