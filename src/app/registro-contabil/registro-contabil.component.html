<!-- registro-contabil.component.html -->
<div class="pagina">
  <aside class="sidebar" [ngClass]="{ 'retraida': sidebarRetraida }">
    <div class="sidebar-header">
      <button class="hamburger-btn" (click)="toggleSidebar()">
        <i class="bx bx-menu"></i>
      </button>
      <div class="logo" *ngIf="!sidebarRetraida">mister <strong>contador</strong></div>
    </div>
    <nav>
      <ul>
        <li class="">
          <i class="bx bx-home"></i>
          <span *ngIf="!sidebarRetraida">Início</span>
        </li>
        <li>
          <i class="bx bx-bar-chart-alt"></i>
          <span *ngIf="!sidebarRetraida">Estatísticas</span>
        </li>
        <li class="active">
          <i class="bx bx-book"></i>
          <span *ngIf="!sidebarRetraida">Registro Contábil</span>
        </li>
        <li>
          <i class="bx bx-file"></i>
          <span *ngIf="!sidebarRetraida">Nf-e</span>
        </li>
        <li>
          <i class="bx bx-file"></i>
          <span *ngIf="!sidebarRetraida">NFS-e</span>
        </li>
        <li>
          <i class="bx bx-receipt"></i>
          <span *ngIf="!sidebarRetraida">Comprovantes</span>
        </li>
        <li>
          <i class="bx bx-credit-card"></i>
          <span *ngIf="!sidebarRetraida">Cartão de Crédito</span>
        </li>
        <li>
          <i class="bx bx-file-blank"></i>
          <span *ngIf="!sidebarRetraida">Extrato bancário</span>
        </li>
        <li>
          <i class="bx bx-list-ul"></i>
          <span *ngIf="!sidebarRetraida">Plano de Contas</span>
        </li>
        <li>
          <i class="bx bx-cog"></i>
          <span *ngIf="!sidebarRetraida">Regras</span>
        </li>
        <li>
          <i class="bx bx-buildings"></i>
          <span *ngIf="!sidebarRetraida">Agência bancária</span>
        </li>
        <li>
          <i class="bx bx-building"></i>
          <span *ngIf="!sidebarRetraida">Empresa</span>
        </li>
        <li>
          <i class="bx bx-user-check"></i>
          <span *ngIf="!sidebarRetraida">Permissões</span>
        </li>
        <li>
          <i class="bx bx-log-out"></i>
          <span *ngIf="!sidebarRetraida">Sair</span>
        </li>
      </ul>
    </nav>
  </aside>

  <main class="conteudo">
    <header class="topo">
      <h1>Registro Contábil</h1>
      <div class="filtros">

        <div class="dropdown">
          <button class="btn btn-outline-seundary dropdown-toggle" data-bs-toggle="dropdown">
            <img class="bank-img"
              src="https://yt3.googleusercontent.com/YoY6PQUzk6UXJEW8sTYs8zf_TfPLHNLSim65mswp_w5CX0jYgtl_le41QPRwoI1Hyj4OM2q_=s900-c-k-c0x00ffffff-no-rj">
            3174 / 40106
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">
                <img class="bank-img"
                  src="https://play-lh.googleusercontent.com/dLVmnD6SlKMWO8_iiw5Cepca0zqmJq3zMaAfXXp6kJfrVBgctX2qTClAOCuaCLn-XmQ">
                0001 / 545498</a></li>
          </ul>
        </div>
        <button type="button" class="btn btn-outline-primary">7-111.02.0001</button>
        <div class="calendario-principal-container">
          <div class="calendario-principal-input" (click)="abrirCalendarioPrincipal()">
            <span>{{ formatarDataExibicaoPrincipal() }}</span>
            <i class="bx bx-calendar"></i>
          </div>

          <!-- Calendário Principal Completo -->
          <div class="calendario-principal" *ngIf="mostrarCalendarioPrincipal" (click)="$event.stopPropagation()">
            <div class="calendario-header">
              <button type="button" (click)="alterarAnoPrincipal(-1)" class="nav-btn">
                <i class="bx bx-chevrons-left"></i>
              </button>

              <span class="calendario-title">{{ anoCalendarioPrincipal }}</span>

              <button type="button" (click)="alterarAnoPrincipal(1)" class="nav-btn">
                <i class="bx bx-chevrons-right"></i>
              </button>
            </div>

            <div class="calendario-grid-meses">
              <div *ngFor="let mes of getMesesDoAno(); let i = index"
                   class="calendario-mes-cell"
                   [class.mes-atual]="isMesAtualPrincipal(i)"
                   [class.mes-selecionado]="isMesSelecionadoPrincipal(i)"
                   (click)="selecionarMesPrincipal(i)">
                {{ mes }}
              </div>
            </div>

            <div class="calendario-footer">
              <button type="button" (click)="fecharCalendarioPrincipal()" class="btn-fechar">Fechar</button>
            </div>
          </div>
        </div>
        <input type="text" placeholder="Pesquisar..." class="pesquisa" />
        <!-- Botões à direita dos filtros -->
        <div class="acoes-botoes d-flex align-items-center gap-2 ms-auto">
          <button class="btn btn-primary">
            <i class="bx bx-list-ul"></i>
          </button>

          <!-- Dropdown "Ações" -->
          <div class="dropdown">
            <button class="btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Ações
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item disabled" href="#">Exportar Lançamentos Contábeis</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Entrada</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NF-e Saída</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Tomado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Baixa NFS-e Prestado</a></li>
              <li><a class="dropdown-item disabled" href="#">Exportar Simples Conferência</a></li>
              <li><a class="dropdown-item disabled" href="#">Gerar Ticket</a></li>
            </ul>
          </div>

          <!-- Botão Excluir -->
          <button class="btn btn-primary">Excluir</button>
        </div>

      </div>

    </header>
    <hr />
    <section class="abas">
      <button [ngClass]="{ 'ativa': abaSelecionada === 'lancamentos' }" (click)="selecionarAba('lancamentos')">
        Lançamentos <span class="badge azul">0002</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'conciliados' }" (click)="selecionarAba('conciliados')">
        Conciliados <span class="badge verde">0003</span>
      </button>
      <button [ngClass]="{ 'ativa': abaSelecionada === 'naoConciliados' }" (click)="selecionarAba('naoConciliados')">
        Não-Conciliados <span class="badge vermelho">0002</span>
      </button>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button class="btn btn-outline-primary" (click)="editarSaldoInicial()">
          Saldo Inicial: {{ formatarMoeda(saldoInicial) }}
        </button>
        <button class="btn btn-outline-primary">
          Saldo Final: {{ formatarMoeda(saldoFinal) }}
        </button>
      </div>
    </section>

    <section class="tabela"
             [ngClass]="{
               'tabela-lancamentos': abaSelecionada === 'lancamentos',
               'tabela-conciliados': abaSelecionada === 'conciliados',
               'tabela-nao-conciliados': abaSelecionada === 'naoConciliados'
             }">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Classificação</th>
            <th>Conta<br>Débito</th>
            <th>Conta<br>Crédito</th>
            <th>Valor</th>
            <th>Histórico</th>
            <th>Comprovante </th>
            <th>Nota</th>
            <th>Cliente</th>
            <th>Anexos</th>
            <th>Saldo</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let linha of dadosLancamentos; let i = index">
            <td>{{ linha.data }}</td>
            <td>{{ linha.classificacao }}</td>

            <!-- Conta Débito -->
            <td>
              <i class="bx bx-book icone-clicavel"
                 *ngIf="i === 1"
                 (click)="abrirModalAssociacaoConta(i); $event.stopPropagation()"
                 title="Associar conta de débito"></i>
              {{ linha.debito }}
            </td>

            <!-- Conta Crédito -->
            <td>
              <i class="bx bx-book icone-clicavel"
                 *ngIf="i === 0"
                 (click)="abrirModalAssociacaoConta(i); $event.stopPropagation()"
                 title="Associar conta de crédito"></i>
              {{ linha.credito }}
            </td>

            <td>{{ linha.valor }}</td>

            <td class="conta-clicavel" (click)="abrirModalRegra(i); $event.stopPropagation()">
              {{ linha.historico }}
            </td>

            <td class="text-center"><i class="bx bx-file"></i></td>
            <td>
              <span *ngIf="linha.temContaAutomatica">{{ linha.nota }}</span>
              <i *ngIf="!linha.temContaAutomatica" class="bx bx-pencil"
                 style="cursor: pointer; color: #007bff;"
                 (click)="abrirModal(i); $event.stopPropagation()"
                 title="Clique para abrir o modal de lançamento contábil"></i>
            </td>
            <td>{{ linha.cliente }}</td>
            <td><i class="bx bx-paperclip"></i></td>
            <td>{{ linha.saldo }}</td>
            <td>
              <span class="status" [ngClass]="linha.status"></span>
            </td>
          </tr>
        </tbody>

      </table>
    </section>


    <!-- Modal Lançamento usando o novo componente -->
    <app-modal-lancamento
      [isVisible]="!!lancamentoSelecionado"
      [lancamento]="lancamentoSelecionado"
      (fechado)="lancamentoSelecionado = null"
      (regrapressed)="abrirModalRegra()"
      (gravado)="onLancamentoGravado($event)">
    </app-modal-lancamento>





    <!-- Modal regra -->
    <div class="modal-regra" *ngIf="modalAberto" (click)="fecharModalRegra()">
      <div class="modal-conteudo-regra" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ modoAssociacaoConta ? 'Associação de Conta' : 'Associação de Regra' }}</h2>
          <button class="fechar" (click)="fecharModalRegra()">×</button>
        </div>
        <div class="modal-body">
          <!-- Campos para associação de conta -->
          <div class="linha" *ngIf="modoAssociacaoConta">
            <div style="flex: 1;">
              <label><strong>Lançamento selecionado:</strong></label>
              <p *ngIf="lancamentoSelecionadoIndex !== null">
                {{ dadosLancamentos[lancamentoSelecionadoIndex]?.historico }}
                ({{ dadosLancamentos[lancamentoSelecionadoIndex]?.valor }})
              </p>
            </div>
          </div>

          <div class="linha" *ngIf="modoAssociacaoConta">
            <div style="flex: 1;">
              <label>Conta Contábil:</label>
              <input type="text" [(ngModel)]="contaContabilInput" placeholder="Digite o número da conta" />
            </div>
          </div>

          <div class="linha" *ngIf="modoAssociacaoConta">
            <div style="flex: 1;">
              <label>Histórico:</label>
              <input type="text" [(ngModel)]="historicoInput" placeholder="Digite o histórico" />
            </div>
          </div>

          <!-- Campos completos para regra normal -->
          <div class="linha" *ngIf="!modoAssociacaoConta">
            <div>
              <label>Data:</label>
              <input type="text" [value]="getDataLancamentoSelecionado()" readonly />
            </div>
            <div>
              <label>Agência Bancária:</label>
              <input type="text" value="4480/2861" readonly />
            </div>
          </div>

          <!-- Descrição apenas no modo regra -->
          <div class="linha" *ngIf="!modoAssociacaoConta">
            <div class="descricao-inline" style="flex: 1;">
              <label for="descricao">Descrição:</label>
              <select id="descricao">
                <option disabled selected>Selecione uma descrição</option>
                <option>Histórico</option>
                <option>Beneficiário</option>
                <option>Informação adicional</option>
              </select>
            </div>
          </div>

          <!-- Campos adicionais apenas no modo regra -->
          <div class="linha" *ngIf="!modoAssociacaoConta">
            <div style="flex: 1;">
              <label>Expressão:</label>
              <input type="text" />
            </div>
          </div>
          <div class="linha" *ngIf="!modoAssociacaoConta">
            <div style="flex: 1;">
              <label>Conta Contábil:</label>
              <input type="text" placeholder="Digite o número da conta" />
            </div>
          </div>
          <div class="linha" *ngIf="!modoAssociacaoConta">
            <div style="flex: 1;">
              <label>Histórico Contábil:</label>
              <input type="text" />
            </div>
          </div>
        </div>
        <div class="rodape-modal">
          <button class="btn btn-primary" (click)="fecharModalRegra()">Cancelar</button>
          <button class="btn btn-primary">Gravar</button>
        </div>
      </div>
    </div>


  </main>
</div>
