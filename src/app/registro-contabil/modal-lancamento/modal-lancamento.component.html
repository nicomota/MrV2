<div class="modal-lancamento" *ngIf="isVisible">
  <div class="modal-conteudo grande">
    <button class="fechar" (click)="fechar()">&times;</button>
    <h1 class="titulo">Lançamento Contábil</h1>
    <hr />

    <div class="linha-container">
      <div class="linha">
        <div><label>Data:</label> <input type="text" [value]="lancamento.data" readonly /></div>
        <div><label>Usuário:</label> <input type="text" value="Diego" readonly /></div>
        <div><label>Empresa:</label> <input type="text" [value]="lancamento.cliente" readonly /></div>
        <div>
          <label>Tipo:</label>
          <select [(ngModel)]="tipoSelecionado" (change)="onTipoSelecionado()">
            <option disabled [selected]="!tipoSelecionado">Escolha um tipo</option>
            <option *ngFor="let tipo of tiposDisponiveis" [value]="tipo">{{ tipo }}</option>
          </select>
        </div>
        <div style="align-self: flex-end;">
          <label style="visibility: hidden;">Criar Regra</label>
          <button class="btn-criar-regra" (click)="criarRegra()">Criar Regra</button>
        </div>
      </div>
    </div>

    <hr />

    <div class="linha-container">
      <div class="linha">
        <div><label>Conta Contábil D:</label> <input type="text" [value]="lancamento?.debito" readonly />
        </div>
        <div><label>Conta Contábil C:</label> <input type="text" [value]="lancamento?.credito" readonly />
        </div>
        <div><label>Valor:</label> <input type="text" [value]="lancamento.valor" readonly /></div>
        <div><label>Histórico Contábil:</label> <input type="text" [value]="lancamento.historico"
            readonly /></div>
      </div>
    </div>

    <hr />

    <div class="header-notas-fiscais">
      <button (click)="toggleNotasFiscais()" class="btn-header-notas">
        <span>{{ notasFiscaisVisiveis ? '▼' : '▶' }} Notas Fiscais</span>
      </button>
    </div>

    <div class="abas-pesquisa-container" *ngIf="notasFiscaisVisiveis">
      <section class="abas-modal">
        <button [ngClass]="{ 'ativa': abaSelecionada === 'nfe' }" (click)="selecionarAba('nfe')">
          NFe
        </button>
        <button [ngClass]="{ 'ativa': abaSelecionada === 'nfse' }" (click)="selecionarAba('nfse')">
          NFSe
        </button>
      </section>

      <div class="pesquisa-container">
        <input type="text"
               placeholder="Pesquisar..."
               class="input-pesquisa"
               [(ngModel)]="termoPesquisa" />

        <select class="dropdown-filtro" [(ngModel)]="filtroSelecionado">
          <option value="numero">Número</option>
          <option value="empresa">Empresa</option>
          <option value="cnpj">CNPJ</option>
          <option value="valorParcela">Valor da Parcela</option>
          <option value="dtParcela">DT Parcela</option>
          <option value="valorLiquido">Valor Líquido</option>
        </select>

        <button class="btn-pesquisar" (click)="pesquisar()">
          <i class="bx bx-search"></i>
        </button>
      </div>
    </div>

    <div class="tabela-container" *ngIf="notasFiscaisVisiveis">
      <!-- Tabela NFe -->
      <table class="subtabela" *ngIf="abaSelecionada === 'nfe'">
        <thead>
          <tr>
            <th>Número Empresa</th>
            <th>DT Parcela</th>
            <th>Valor Nota</th>
            <th>Parcela</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let parcela of parcelasData">
            <td>{{ parcela.numeroEmpresa }}</td>
            <td>{{ parcela.dtParcela }}</td>
            <td>{{ parcela.valorNota | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ parcela.parcela }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Tabela NFSe -->
      <table class="subtabela" *ngIf="abaSelecionada === 'nfse'">
        <thead>
          <tr>
            <th>Número</th>
            <th>Razão Social</th>
            <th>CNPJ</th>
            <th>Data da Parcela</th>
            <th>Valor da Parcela</th>
            <th>Valor Líquido</th>
            <th>ISS</th>
            <th>IR</th>
            <th>INSS</th>
            <th>PIS</th>
            <th>COFINS</th>
            <th>CSLL</th>
            <th>Desconto</th>
            <th>Parcela</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let nfse of nfseData">
            <td>{{ nfse.numero }}</td>
            <td>{{ nfse.razaoSocial }}</td>
            <td>{{ nfse.cnpj }}</td>
            <td>{{ nfse.dataParcela }}</td>
            <td>{{ nfse.valorParcela | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.valorLiquido | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.iss | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.ir | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.inss | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.pis | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.cofins | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.csll | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.desconto | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
            <td>{{ nfse.parcela }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr />

    <table class="subtabela">
      <thead>
        <tr>
          <th>Debitar</th>
          <th>Creditar</th>
          <th>Classificação</th>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Histórico Contábil</th>
          <th>Excluir</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let linha of linhasSubtabela; let i = index">
          <!-- Debitar -->
          <td>
            <input *ngIf="linha.tipo === 'debito'" type="text" [(ngModel)]="linha.debitar"
              [readonly]="!linha.editavel">
            <span *ngIf="linha.tipo === 'credito'">-</span>
          </td>

          <!-- Creditar -->
          <td>
            <input *ngIf="linha.tipo === 'credito'" type="text" [(ngModel)]="linha.creditar"
              [readonly]="!linha.editavel">
            <span *ngIf="linha.tipo === 'debito'">-</span>
          </td>

          <!-- Classificação -->
          <td>
            <input type="text" [(ngModel)]="linha.classificacao" [readonly]="!linha.editavel">
          </td>

          <!-- Descrição -->
          <td>
            <input type="text" [(ngModel)]="linha.descricao" [readonly]="!linha.editavel">
          </td>

          <!-- Valor -->
          <td>
            <input type="text" [(ngModel)]="linha.valor" (ngModelChange)="atualizarTotais()" [readonly]="!linha.editavel">
          </td>

          <!-- Histórico -->
          <td>
            <input type="text" [(ngModel)]="linha.historico" [readonly]="!linha.editavel">
          </td>

          <!-- Ações -->
          <td>
            <button *ngIf="linha.editavel" class="btn btn-outline-danger btn-sm"
              (click)="removerLinha(i)">−</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Botões de adicionar linha -->
    <div class="botoes-linhas" style="margin-top: 1rem;">
      <!-- Para tipos N x N: mostra dois botões -->
      <ng-container
        *ngIf="tipoSelecionado === 'N Débito p/ N Crédito' || tipoSelecionado === 'N Crédito p/ N Débito'">
        <button (click)="adicionarLinha('debito')">+ Adicionar Débito</button>
        <button (click)="adicionarLinha('credito')">+ Adicionar Crédito</button>
      </ng-container>

      <!-- Para tipos Um x Vários: botão único -->
      <ng-container *ngIf="tipoSelecionado === 'Um Débito p/ vários Créditos'">
        <button (click)="adicionarLinha('credito')">+ Adicionar Crédito</button>
      </ng-container>

      <ng-container *ngIf="tipoSelecionado === 'Um Crédito p/ vários Débitos'">
        <button (click)="adicionarLinha('debito')">+ Adicionar Débito</button>
      </ng-container>
    </div>

    <hr />

    <div class="linha-container">
      <div class="linha-final">
        <div><label>Débito:</label>
          <input type="text" [value]="totalDebito | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
        </div>
        <div><label>Crédito:</label>
          <input type="text" [value]="totalCredito | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
        </div>
        <div><label>Diferença:</label>
          <input type="text" [value]="diferenca | currency:'BRL':'symbol-narrow':'1.2-2'" readonly />
        </div>
        <div><label>Doc nº:</label> <input type="text" value="0199999999" readonly /></div>
        <div><button class="botao-nfe">Nf-e {{ lancamento.nota }}</button></div>
      </div>
    </div>

    <div class="rodape-modal">
      <span *ngIf="diferenca !== 0" class="aviso-saldo">O saldo (diferença) precisa ser zero para gravar.</span>
      <button class="btn-cancelar" (click)="fechar()">Cancelar</button>
      <button class="btn-gravar" (click)="gravar()" [disabled]="diferenca !== 0">Gravar</button>
    </div>
  </div>
</div>